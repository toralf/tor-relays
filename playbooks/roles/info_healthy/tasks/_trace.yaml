---
- name: Check for a known trace
  delegate_to: localhost
  throttle: 1
  ansible.builtin.lineinfile:
    line: "{{ _codeline }}"
    path: "{{ tmp_dir }}/trace-codeline.txt"
    regexp: "^{{ _codeline }}$"
  register: _known

- name: Work on new trace
  when: _known.changed
  block:
    - name: Get full trace
      changed_when: false
      ansible.builtin.shell:
        cmd: |-
          set -o pipefail

          journalctl --since "{{ trace_since }}" --quiet |
            awk "/{{ _headline | regex_replace('\/', '\\/') | regex_replace('\[', '\\[') }}/,/ kernel: ---\[ end trace /" |
            head -n 999
        executable: /bin/bash
      register: _full

    - name: File full trace
      delegate_to: localhost
      throttle: 1
      ansible.builtin.blockinfile:
        block: |
          #    {{ inventory_hostname }}    {{ now(utc=true, fmt='%Y-%m-%d %H:%M:%S') }}    {{ ansible_facts.lsb.description }}
          {{ _full.stdout }}
        path: "{{ tmp_dir }}/trace-full.txt"
        marker: "# {mark} {{ _codeline }} "
        marker_begin: "TRACE BEGIN"
        marker_end: "TRACE END"

    - name: Get dmesg for the trace
      ansible.builtin.include_tasks: _dmesg.yaml

    - name: Get kernel config for the trace
      ansible.builtin.include_tasks: _kernel-config.yaml
