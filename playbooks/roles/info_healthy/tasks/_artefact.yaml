---
- name: Check for a known artefact
  delegate_to: localhost
  throttle: 1
  ansible.builtin.lineinfile:
    line: "{{ item.checksum }}"
    path: "{{ tmp_dir }}/artefact.log"
  register: _known

- name: Work on new artefact
  when: _known.changed
  vars:
    _tmp_filename: "{{ tmp_dir }}/{{ item.checksum }}"
  block:
    - name: Log artefact history
      delegate_to: localhost
      throttle: 1
      ansible.builtin.lineinfile:
        line: "{{ item.checksum }}    {{ now(utc=true, fmt='%Y-%m-%d %H:%M:%S') }}    {{ inventory_hostname }}"
        path: "{{ tmp_dir }}/artefact-history.log"

    - name: Fetch
      throttle: 1
      ansible.builtin.fetch:
        src: "{{ item.path }}"
        dest: "{{ _tmp_filename }}"

    - name: Inspect artefact file type
      delegate_to: localhost
      throttle: "{{ concurrent_local_jobs }}"
      changed_when: false
      ansible.builtin.command:
        cmd: >-
          file {{ _tmp_filename }}
      register: _filetype

    - name: Print out artefact file type
      changed_when: true
      ansible.builtin.debug:
        var: _filetype.stdout_lines

    - name: External script for artefact
      when: artefact_hook
      block:
        - name: Run script for artefact
          delegate_to: localhost
          throttle: "{{ concurrent_local_jobs }}"
          changed_when: false
          ansible.builtin.shell: # noqa: command-instead-of-shell
            cmd: >-
              {{ artefact_hook }} {{ _tmp_filename }}
          register: _script

      always:
        - name: Script stdout for artefact
          when: _script.stdout | length > 0
          changed_when: true
          ansible.builtin.debug:
            var: _script.stdout_lines

        - name: Script stderr for artefact
          when: _script.stderr | length > 0
          changed_when: true
          ansible.builtin.debug:
            var: _script.stderr_lines

  rescue:
    - name: Reset known state of artefact
      delegate_to: localhost
      throttle: 1
      ansible.builtin.lineinfile:
        line: "{{ item.checksum }}"
        path: "{{ tmp_dir }}/artefact.log"
        state: absent

  always:
    - name: Cleanup artefact
      delegate_to: localhost
      throttle: 1
      when: artefact_cleanup
      ansible.builtin.file:
        path: "{{ _tmp_filename }}"
        state: absent
