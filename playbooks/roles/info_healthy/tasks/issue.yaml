---
- name: Grep system log for an issue
  changed_when: false
  failed_when: _result.stderr | length > 0 or _result.rc > 0
  ansible.builtin.shell:
    cmd: |-
      journalctl --since "{{ issue_since }}" --quiet |
        grep -v -F 'Speculative Return Stack Overflow: WARNING:' |
        grep -F \
          -e '(nowflake)' \
          -e 'BUG:' \
          -e 'BUG at' \
          -e 'Call Trace:' \
          -e 'invoked oom-killer' \
          -e 'No space left on device' \
          -e 'Oops:' \
          -e 'status=9/KILL' \
          -e '.service: Failed' \
          -e 'WARNING:' |
        head -n 500
  register: _result

- name: File issue
  delegate_to: localhost
  throttle: 1
  ansible.builtin.blockinfile:
    block: "{{ _result.stdout }}"
    path: "{{ tmp_dir }}/issue-current.log"
    marker: "# {mark} {{ inventory_hostname }} "
    state: "{{ (_result.stdout | length > 0) | ternary('present', 'absent') }}"
