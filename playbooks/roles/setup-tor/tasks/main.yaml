---
- name: Validate
  ansible.builtin.import_tasks: validate.yaml
  tags:
    - validate

- name: Main
  module_defaults:
    ansible.builtin.apt:
      autoclean: true
      autoremove: true
      cache_valid_time: 600
      purge: true
      state: latest
    ansible.builtin.copy:
      owner: root
      group: root
      mode: "0644"
    ansible.builtin.file:
      owner: root
      group: root
      mode: "0644"
    ansible.builtin.lineinfile:
      owner: root
      group: root
      mode: "0644"
    ansible.builtin.template:
      owner: root
      group: root
      mode: "0644"
  block:
    - name: Firewall
      ansible.builtin.import_tasks: firewall.yaml
      tags:
        - firewall
    - name: Debian
      when: tor_vendor == "debian"
      ansible.builtin.import_tasks: tor-debian.yaml
      tags:
        - tor
        - tor-debian
    - name: Git
      when: tor_vendor == "git"
      ansible.builtin.import_tasks: tor-git.yaml
      tags:
        - tor
        - tor-git
    - name: Git
      ansible.builtin.import_tasks: tor-config.yaml
      tags:
        - tor
        - tor-config
    - name: Lyrebird
      when: (tor_vendor == "git") and (obfs4_port > 0) and (obfs4_port < 2**16)
      ansible.builtin.import_tasks: tor-lyrebird.yaml
      tags:
        - tor
        - tor-lyrebird
