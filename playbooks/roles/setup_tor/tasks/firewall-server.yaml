---
- name: Install or update software for Tor server firewall
  ansible.builtin.apt:
    name:
      - ipset
      - jq

- name: Download iptables scripts
  ansible.builtin.get_url:
    url: "https://github.com/toralf/torutils/raw/main/{{ item }}"
    dest: "/root/{{ item }}"
    mode: "0744"
    force: true
  with_items:
    - ipv4-rules.sh
    - ipv6-rules.sh
  notify: "Restart Firewall"

- name: Create cron job to start firewall after reboot
  ansible.builtin.cron:
    name: "start firewall"
    special_time: reboot
    job: "{{ add_remote_service }} /root/ipv4-rules.sh start; /root/ipv6-rules.sh start"
  notify: "Restart Firewall"

- name: Create ron job to save ipsets
  ansible.builtin.cron:
    name: "save ipset"
    special_time: hourly
    job: "/root/ipv4-rules.sh save; /root/ipv6-rules.sh save"

- name: Ensure persistent iptables package is removed
  when: not ansible_check_mode
  ansible.builtin.apt:
    name:
      - iptables-persistent
    state: absent
