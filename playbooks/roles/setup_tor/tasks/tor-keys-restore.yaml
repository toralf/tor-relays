---
- name: Test for existance of backed up Tor keys
  delegate_to: localhost
  throttle: "{{ concurrent_local_jobs }}"
  ansible.builtin.stat:
    path: "{{ infodir }}/tor-keys/{{ inventory_hostname }}"
  register: _keys_backup

- name: Restore
  when: _keys_backup.stat.exists and not _keys.stat.exists
  block:
    - name: Create Tor keys dir
      ansible.builtin.file:
        state: directory
        path: /var/lib/tor/keys/
        mode: u=rwx,g=s,o=
        owner: tor
        group: tor

    - name: Restore Tor keys
      throttle: "{{ concurrent_local_jobs }}"
      ansible.builtin.copy:
        src: "{{ infodir }}/tor-keys/{{ inventory_hostname }}/"
        dest: "/var/lib/tor/keys/"
        mode: "0600"
        owner: tor
        group: tor
      notify: Restart Tor
