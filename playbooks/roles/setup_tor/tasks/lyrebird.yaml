---
- name: Init or update Lyrebird repo
  when: not ansible_check_mode
  ansible.builtin.git:
    repo: https://gitlab.torproject.org/tpo/anti-censorship/pluggable-transports/lyrebird
    dest: /root/lyrebird
    version: "{{ lyrebird_git_version }}"
    force: true
  register: _repo_lyrebird

- name: Apply patches for Lyrebird
  changed_when: _lyrebird_patched.stdout_lines is search('patching file ')
  ansible.builtin.shell:
    cmd: curl -s {{ item }} | patch -p 1
    chdir: /root/lyrebird
  loop_control:
    label: "{{ item }}"
  loop: "{{ lyrebird_patches }}"
  register: _lyrebird_patched

- name: Build Lyrebird
  when: _repo_lyrebird.changed or _lyrebird_patched.changed
  changed_when: true
  ansible.builtin.command:
    cmd: make build
    chdir: /root/lyrebird

- name: Install Lyrebird
  ansible.builtin.copy:
    src: /root/lyrebird/lyrebird
    dest: /usr/bin/
    mode: a+x
    remote_src: yes
  register: _lyrebird_install
  notify: "restart Tor"

# for systemd see CapabilityBoundingSet, NoNewPrivileges, PrivateDevices and more
- name: Allow low port for Lyrebird
  when: tor_port | int < 1024
  community.general.capabilities:
    path: /usr/bin/lyrebird
    capability: cap_net_bind_service=+ep
    state: present
  notify: "restart Tor"
