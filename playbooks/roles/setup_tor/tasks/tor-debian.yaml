---
- name: Get Tor repository apt key
  ansible.builtin.apt_key:
    url: "https://deb.torproject.org/torproject.org/A3C4F0F979CAA22CDBA8F512EE8CBC9E886DDD89.asc"
    state: present

- name: Configure Debian repository "torproject"
  ansible.builtin.apt_repository:
    filename: "torproject"
    repo: "deb https://deb.torproject.org/torproject.org {{ ansible_facts.distribution_release }} main"
    state: present

- name: Configure Debian repository "torproject" for tor_debian_target
  when: tor_debian_target
  ansible.builtin.apt_repository:
    filename: "torproject"
    repo: "deb https://deb.torproject.org/torproject.org {{ tor_debian_target }} main"
    state: present

- name: Install or update key ring
  when: not ansible_check_mode
  ansible.builtin.apt:
    name:
      - deb.torproject.org-keyring

- name: Install or update obfs4proxy
  when: not ansible_check_mode
  ansible.builtin.apt:
    default_release: "{{ tor_debian_target | default(ansible_facts.distribution_release) }}"
    name:
      - tor
      - tor-geoipdb
      - obfs4proxy
  notify: "restart Tor"

# https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=1021911
- name: Allow low port
  when: tor_port | int < 1024
  block:
    - name: Configure apt hook to use low port for obfs4proxy
      when: bridge_distribution | length > 0
      ansible.builtin.lineinfile:
        line: 'DPkg::Post-Invoke { "setcap cap_net_bind_service=+ep /usr/bin/obfs4proxy"; };'
        path: /etc/apt/apt.conf.d/99-obfs4proxy-capability
        create: yes

    - name: Configure apt hook to use low port for Tor
      when: bridge_distribution | length == 0
      ansible.builtin.lineinfile:
        line: 'DPkg::Post-Invoke { "setcap cap_net_bind_service=+ep /usr/bin/tor"; };'
        path: /etc/apt/apt.conf.d/99-tor-capability
        create: yes

    - name: Override systemd defaults for Tor
      ansible.builtin.blockinfile:
        create: true
        dest: /etc/systemd/system/tor@default.service.d/override.conf
        content: |
          [Service]
          NoNewPrivileges=no
      notify: "restart Tor"

- name: Set sysctl max user namespaces
  ansible.posix.sysctl:
    name: user.max_user_namespaces
    value: "0" # Debian  bookworm default: 14886
    sysctl_file: /etc/sysctl.d/21tor-relay.conf
    sysctl_set: true
  notify: "restart Tor"
