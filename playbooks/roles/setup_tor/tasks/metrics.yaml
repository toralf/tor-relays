---
- name: Download DDoS metrics script
  throttle: 50
  retries: 3
  when: tor_metrics_ddos
  ansible.builtin.get_url:
    url: "https://github.com/toralf/torutils/raw/main/metrics.sh"
    dest: "/root/metrics.sh"
    mode: "0744"
    force: true
  register: _metrics_ddos

- name: Cron job for DDoS metrics
  ansible.builtin.cron:
    name: "DDoS metrics"
    special_time: reboot
    job: "nice /root/metrics.sh 60"
    state: "{{ tor_metrics_ddos | ternary('present', 'absent') }}"

- name: Ensure DDoS metris are delivered
  changed_when: true
  vars:
    _kill_cmd: "{{ _metrics_ddos.changed | ternary('pkill -f /root/metrics.sh &>/dev/null', ':') }}"
  ansible.builtin.shell:
    cmd: |

      {{ _kill_cmd }}
      if ! pgrep -f /root/metrics.sh &>/dev/null; then
        nice /root/metrics.sh 60 &
      fi
    executable: /bin/bash
