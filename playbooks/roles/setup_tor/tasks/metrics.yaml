---
- name: Download DDoS metrics script
  throttle: 50
  retries: 3
  when: tor_metrics_ddos
  ansible.builtin.get_url:
    url: "https://github.com/toralf/torutils/raw/main/metrics.sh"
    dest: "/root/metrics.sh"
    mode: "0744"
    force: true
  register: _metrics_ddos

- name: Cron job for DDoS metrics
  ansible.builtin.cron:
    name: "DDoS metrics"
    special_time: reboot
    job: "nice /root/metrics.sh 60"
    state: "{{ tor_metrics_ddos | ternary('present', 'absent') }}"

- name: Ensure DDoS metrics script is running
  changed_when: true
  when: _metrics_ddos.changed
  ansible.builtin.shell:
    cmd: |-
      if [[ -s /tmp/torutils-metrics.sh.lock ]]; then
        if ! kill -15 $(cat /tmp/torutils-metrics.sh.lock) &>/dev/null; then
          echo "outdated lock file found"
        fi
      fi
      nice /root/metrics.sh 60 &
    executable: /bin/bash
