---
- name: Gather facts
  ansible.builtin.setup:
    gather_subset: "{{ facts_subset }}"
  tags:
    - always

- name: Validate
  ansible.builtin.import_tasks: validate.yaml
  tags:
    - always

- name: Main
  module_defaults:
    ansible.builtin.apt:
      autoclean: true
      autoremove: true
      cache_valid_time: 600
      purge: true
      state: latest
    ansible.builtin.copy:
      owner: root
      group: root
      mode: "0644"
    ansible.builtin.file:
      owner: root
      group: root
      mode: "0644"
    ansible.builtin.lineinfile:
      owner: root
      group: root
      mode: "0644"
    ansible.builtin.template:
      owner: root
      group: root
      mode: "0644"
  block:
    - name: System
      ansible.builtin.import_tasks: system.yaml
      tags:
        - system

    - name: Swap
      ansible.builtin.import_tasks: swap.yaml
      tags:
        - swap

    - name: IPv6
      when: ansible_facts.bios_vendor == 'Hetzner'
      ansible.builtin.import_tasks: ipv6.yaml
      tags:
        - ipv6

    - name: Firewall
      ansible.builtin.import_tasks: firewall.yaml
      tags:
        - firewall

    - name: Prometheus node exporter
      when: prometheus_node_exporter is true
      ansible.builtin.import_tasks: prometheus-node-exporter.yaml
      tags:
        - prometheus-node-exporter

    - name: metrics
      when: metrics_port is defined and metrics_port != "" and prometheus_server is defined and prometheus_server != ""
      ansible.builtin.import_tasks: metrics.yaml
      tags:
        - metrics

    - name: Timer
      ansible.builtin.import_tasks: timer.yaml
      tags:
        - timer

    - name: Kernel Debian
      when: kernel_debian_repo != "" and kernel_debian_version != ""
      ansible.builtin.import_tasks: kernel-debian.yaml
      tags:
        - kernel-debian

    - name: Kernel Git
      when: kernel_git_revision != ""
      ansible.builtin.import_tasks: kernel-git.yaml
      tags:
        - kernel-git

    - name: Reboot
      ansible.builtin.import_tasks: reboot.yaml
      tags:
        - reboot

  rescue:
    - name: Rescue setup
      ansible.builtin.debug:
        msg: "Setup failed"
