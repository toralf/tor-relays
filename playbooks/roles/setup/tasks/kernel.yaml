---
- name: Setup "{{ kernel_repo }}" repo
  block:
    - name: Configure repository "{{ kernel_repo }}"
      ansible.builtin.apt_repository:
        filename: "{{ kernel_repo }}"
        repo: "deb http://deb.debian.org/debian {{ kernel_repo }} main"
    - name: Apt pinning for "{{ kernel_repo }}" kernel
      ansible.builtin.copy:
        src: apt-preferences
        dest: /etc/apt/preferences

- name: Install or update "{{ kernel_repo }}" kernel
  when: kernel_version != ""
  block:
    - name: Gather facts for "{{ kernel_repo }}" kernel
      ansible.builtin.setup:
        gather_subset:
          - cmdline
      tags:
        - facts
    - name: Install or update "{{ kernel_repo }}" kernel
      ansible.builtin.apt:
        default_release: "{{ kernel_repo }}"
        name:
          - "linux-image-{{ kernel_version }}-{{ ansible_facts.proc_cmdline.BOOT_IMAGE is search('-amd64') | ternary('amd64', 'arm64') }}-unsigned"
