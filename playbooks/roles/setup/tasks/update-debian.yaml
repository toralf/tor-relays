---
- name: Upgrade distribution
  ansible.builtin.apt:
    upgrade: dist

- name: Install or update base software
  when: not ansible_check_mode
  ansible.builtin.apt:
    name:
      - apt-transport-https
      - conntrack
      - cron
      - gpg
      - gpg-agent
      - htop
      - iptables
      - iptables-persistent
      - needrestart
      - ntp
      - psmisc
      - unattended-upgrades

- name: Install or update additional software
  when: additional_software | length > 0
  ansible.builtin.apt:
    name: "{{ additional_software }}"

- name: Configure auto upgrades
  ansible.builtin.copy:
    src: 20auto-upgrades
    dest: /etc/apt/apt.conf.d/

- name: Configure unattended upgrades
  ansible.builtin.copy:
    src: 50unattended-upgrades
    dest: /etc/apt/apt.conf.d/

- name: Check if reboot is required
  changed_when: _reboot_needed.stat.exists
  ansible.builtin.stat:
    path: /var/run/reboot-required
  register: _reboot_needed
  notify: "reboot system"

- name: Check if restart is needed
  changed_when: _restart_needed.stdout_lines | length > 0
  failed_when: false
  ansible.builtin.shell:
    cmd: |
      needrestart -b | grep -e 'NEEDRESTART-KSTA: 2' -e 'NEEDRESTART-KSTA: 3' -e 'NEEDRESTART-SVC'
  register: _restart_needed
  notify: "reboot system"
