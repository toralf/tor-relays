---
- name: Install or update firewall related packages
  ansible.builtin.apt:
    name:
      - conntrack
      - iptables
      - iptables-persistent

- name: Create initial firewall script
  ansible.builtin.template:
    src: "{{ 'firewall-ip' + item + '.sh.j2' }}"
    dest: "{{ '/root/firewall-ip' + item + '.sh' }}"
    mode: "0700"
  with_items:
    - "v4"
    - "v6"

- name: Start firewall
  ansible.builtin.shell: "{{ '/root/firewall-ip' + item + '.sh' }} start"
  with_items:
    - "v4"
    - "v6"

- name: Save new iptables
  community.general.iptables_state:
    ip_version: "{{ 'ip' + item }}"
    state: saved
    path: "{{ '/etc/iptables/rules.' + item }}"
  with_items:
    - "v4"
    - "v6"
