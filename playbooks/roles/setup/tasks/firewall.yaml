---
- name: Create firewall script
  ansible.builtin.template:
    src: "firewall-ip{{ item }}.sh.j2"
    dest: "/root/firewall-ip{{ item }}.sh"
    mode: "0700"
  with_items:
    - "v4"
    - "v6"
  register: _fw_scripts

- name: Gather state of services
  ansible.builtin.service_facts:

- name: Save iptables state
  when: ansible_facts.services["netfilter-persistent.service"].status == "enabled"
  community.general.iptables_state:
    ip_version: "ip{{ item }}"
    state: saved
    path: "/etc/iptables/rules.{{ item }}"
  with_items:
    - "v4"
    - "v6"
  register: _fw_old

- name: Reset firewall
  when: _fw_scripts.changed or _fw_old.changed or firewall_force_reset
  block:
    - name: Start firewall
      changed_when: true
      ansible.builtin.command:
        cmd: "/root/firewall-ip{{ item }}.sh start"
      with_items:
        - "v4"
        - "v6"

    - name: Save iptables state of setup
      community.general.iptables_state:
        ip_version: "ip{{ item }}"
        state: saved
        path: "/etc/iptables/rules.{{ item }}"
      with_items:
        - "v4"
        - "v6"
