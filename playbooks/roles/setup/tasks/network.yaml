---
- name: Get ipv6 netmask
  delegate_to: localhost
  changed_when: false
  ansible.builtin.shell: |
    hcloud server list --output columns=name,ipv6 | awk '/^{{ ansible_hostname }} / { print $2 }'
  register: result

- name: Get ipv6 prefix
  ansible.builtin.set_fact:
    _ipv6_prefix: "{{ result.stdout | replace('::/64', '') }}"

# avoid first 1024 addresses, especially <prefix>::1 till <prefix>::254
- name: Dice ipv6 subnet values
  ansible.builtin.set_fact:
    _a: "{{ range(0,65535) | random(seed=seed_or_port + ansible_hostname + ipv4 + 'A' + result.stdout) }}"
    _b: "{{ range(0,65535) | random(seed=seed_or_port + ansible_hostname + ipv4 + 'B' + result.stdout) }}"
    _c: "{{ range(0,65535) | random(seed=seed_or_port + ansible_hostname + ipv4 + 'C' + result.stdout) }}"
    _d: "{{ range(1024,65535) | random(seed=seed_or_port + ansible_hostname + ipv4 + 'D' + result.stdout) }}"

- name: Compile ipv6 host part
  ansible.builtin.set_fact:
    _ipv6_suffix: "{{ _a }}.{{ _b }}.{{ _c }}.{{ _d }}"

- name: Compile global scope ipv6 address
  ansible.builtin.set_fact:
    _ipv6: "{{ _ipv6_prefix }}:{{ _ipv6_suffix | ansible.utils.ip4_hex(':') }}"

- name: Ensure that Hetzner network configurator is deactivated
  ansible.builtin.copy:
    src: 00_debian.cfg
    dest: /etc/cloud/cloud.cfg.d/

- name: Ensure global scope ipv6 is set
  ansible.builtin.lineinfile:
    create: yes
    path: "/etc/network/interfaces.d/50-cloud-init"
    line: "    address {{ _ipv6 }}/64 dev eth0"
    regex: "^    address {{ _ipv6_prefix }}:"

- name: Restart network service
  ansible.builtin.systemd:
    name: "networking"
    state: restarted
    daemon_reload: yes
    enabled: yes

- name: Gather ipv6 facts
  ansible.builtin.setup:
    gather_subset:
      - "!all"
      - "all_ipv6_addresses"
    gather_timeout: 20
  failed_when: ansible_eth0.ipv6 | selectattr("scope", "eq", "global") | length != 1

- name: Flush table nat of chain PREROUTING
  ansible.builtin.iptables:
    ip_version: ipv6
    table: nat
    chain: PREROUTING
    flush: true

- name: Accept incoming TCP v6 to the global scope ipv6 address
  ansible.builtin.iptables:
    ip_version: ipv6
    table: nat
    chain: PREROUTING
    protocol: tcp
    destination: "{{ _ipv6 }}"
    jump: ACCEPT

- name: DNAT incoming TCP v6 to the global scope ipv6 address (except first 1024 addresses)
  ansible.builtin.iptables:
    ip_version: ipv6
    table: nat
    chain: PREROUTING
    protocol: tcp
    destination: "! {{ _ipv6_prefix }}::/118"
    jump: DNAT
    to_destination: "{{ _ipv6 }}"

- name: Persist IPv6 rules
  ansible.builtin.shell: "/usr/sbin/ip6tables-save > /etc/iptables/rules.v6"
