---
- name: Gather the package facts
  ansible.builtin.package_facts:
    manager: auto

- name: Current running kernel
  changed_when: false
  ansible.builtin.shell: |
    uname -v | cut -f 4 -d ' '
    uname -r | cut -f 3 -d '-'
  register: result

- name: Set fact for linux package name
  ansible.builtin.set_fact:
    linux_image_arch: "linux-image-{{ result.stdout_lines[1] }}"

- name: Reboot into newer kernel
  ansible.builtin.reboot:
    msg: "Reboot initiated by Ansible"
    connect_timeout: 5
    reboot_timeout: 120
    pre_reboot_delay: 0
    post_reboot_delay: 30
    test_command: uptime
  when: not result.stdout_lines[0] == ansible_facts.packages[linux_image_arch][0].version
