---

- name: Gather the package facts
  ansible.builtin.package_facts:
    manager: auto

- name: Uname
  ansible.builtin.shell: |
    uname -v
  register: result

- name: Reboot into installed kernel
  ansible.builtin.reboot:
    msg: "Reboot initiated by Ansible"
    connect_timeout: 5
    reboot_timeout: 300
    pre_reboot_delay: 0
    post_reboot_delay: 30
    test_command: uptime
  when: force_reboot or not result.stdout | regex_search(ansible_facts.packages['linux-image-amd64'][0].version)
