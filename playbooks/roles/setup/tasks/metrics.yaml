---
- name: Install or update Nginx
  ansible.builtin.apt:
    name:
      - nginx
  register: _installed

- name: miau
  when: group_names is contains('snowflake')
  debug:
    msg: "jo"

- name: Check if key does exist
  ansible.builtin.stat:
    path: /etc/ssl/private/nginx-selfsigned.key
  register: _keyfile

- name: Check if crt does exist
  ansible.builtin.stat:
    path: /etc/ssl/certs/nginx-selfsigned.crt
  register: _crtfile

- name: Generate SSL certificate
  when: not _keyfile.stat.exists or not _crtfile.stat.exists
  ansible.builtin.command: |
    openssl req -x509 -nodes -days 3650 -newkey rsa:4096 \
      -keyout /etc/ssl/private/nginx-selfsigned.key \
      -out /etc/ssl/certs/nginx-selfsigned.crt \
      -subj "/C=AB/O=cdefgh/OU=ijklmn/CN=*.snakeoil.com"
  register: _cert

- name: Configure Nginx
  ansible.builtin.template:
    src: nginx.conf.j2
    dest: /etc/nginx/conf.d/metrics.conf
    mode: "0644"
  register: _configfile

- name: Restart Nginx
  when: _installed.changed or _cert.changed or _configfile.changed
  ansible.builtin.service:
    name: nginx
    state: restarted
    daemon_reload: true
    enabled: true
