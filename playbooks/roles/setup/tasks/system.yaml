---
- name: Create Ansible tmp dir for user root
  ansible.builtin.file:
    path: /root/.ansible/tmp
    state: directory
    mode: "0700"

- name: Deactivate ssh login via password
  ansible.builtin.shell:
    cmd: |
      if grep -q "^PermitRootLogin yes" /etc/ssh/sshd_config; then
        sed -i -e 's,^PermitRootLogin yes,#PermitRootLogin yes,' /etc/ssh/sshd_config
        service sshd restart
        sleep 5
      fi

- name: Upgrade distribution
  ansible.builtin.apt:
    upgrade: dist

- name: Install or update base software
  when: not ansible_check_mode
  ansible.builtin.apt:
    name:
      - apt-transport-https
      - conntrack
      - cron
      - gpg
      - gpg-agent
      - htop
      - iptables
      - iptables-persistent
      #- net-tools
      - ntp
      - psmisc
      - unattended-upgrades

- name: Install or update additional software
  when: additional_software | length > 0
  ansible.builtin.apt:
    name: "{{ additional_software }}"

- name: Configure auto upgrades
  ansible.builtin.copy:
    src: 20auto-upgrades
    dest: /etc/apt/apt.conf.d/

- name: Configure unattended upgrades
  ansible.builtin.copy:
    src: 50unattended-upgrades
    dest: /etc/apt/apt.conf.d/

- name: Sysctl config
  ansible.builtin.copy:
    src: 20tor-system.conf
    dest: /etc/sysctl.d/
  register: _sysctl_state

- name: "Ensure sysctl is reloaded"
  when: _sysctl_state.changed
  changed_when: true
  ansible.builtin.command: sysctl --system

- name: Tweak readline
  ansible.builtin.lineinfile:
    line: "set enable-bracketed-paste off"
    path: /root/.inputrc
    create: yes

- name: Htop config
  ansible.builtin.copy:
    src: htoprc
    dest: /root/.config/htop/

- name: Ensure kernel crash dumps are made to /tmp
  ansible.builtin.cron:
    name: "core debug files"
    special_time: reboot
    job: "echo '/tmp/core.\\%e.\\%p.\\%s.\\%t' > /proc/sys/kernel/core_pattern"
