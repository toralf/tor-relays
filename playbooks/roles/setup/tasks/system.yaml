---
- name: Create Ansible tmp dir for user root
  ansible.builtin.file:
    path: /root/.ansible/tmp
    state: directory
    mode: "0700"

- name: Configure repository "backports"
  ansible.builtin.apt_repository:
    filename: "backports"
    repo: "deb http://deb.debian.org/debian {{ ansible_facts.distribution_release }}-backports main"

- name: Install or update base software
  ansible.builtin.apt:
    name:
      - apt-transport-https
      - gpg
      - gpg-agent
      - ntp
      - unattended-upgrades

- name: Install or update additional software
  when: additional_software | length > 0
  ansible.builtin.apt:
    name: "{{ additional_software }}"

- name: Configure auto upgrades
  ansible.builtin.copy:
    src: 20auto-upgrades
    dest: /etc/apt/apt.conf.d/

- name: Configure unattended upgrades
  ansible.builtin.copy:
    src: 50unattended-upgrades
    dest: /etc/apt/apt.conf.d/

- name: Sysctl config
  ansible.builtin.copy:
    src: 20tor-system.conf
    dest: /etc/sysctl.d/
  register: _sysctl_state

- name: "Ensure sysctl is reloaded"
  changed_when: true
  ansible.builtin.command:
    argv: ["sysctl", "--system"]
  when: _sysctl_state.changed

- name: Tweak readline
  ansible.builtin.lineinfile:
    line: "set enable-bracketed-paste off"
    path: /root/.inputrc
    create: yes

- name: Htop config
  ansible.builtin.copy:
    src: htoprc
    dest: /root/.config/htop/

- name: Ensure kernel crash dumps are made to /tmp
  ansible.builtin.cron:
    name: "core debug files"
    special_time: reboot
    job: "echo '/tmp/core.\\%e.\\%p.\\%s.\\%t' > /proc/sys/kernel/core_pattern"

- name: Install unstable kernel
  when: unstable_kernel_version
  block:
    - name: Configure repository "{{ unstable_kernel_repo }}"
      ansible.builtin.apt_repository:
        filename: "{{ unstable_kernel_repo }}"
        repo: "deb http://deb.debian.org/debian {{ unstable_kernel_repo }} main"
    - name: Apt pinning
      ansible.builtin.copy:
        src: apt-preferences
        dest: /etc/apt/preferences
    - name: Gather facts for "{{ unstable_kernel_repo }}" kernel
      ansible.builtin.setup:
        gather_subset:
          - cmdline
    - name: Install or update "{{ unstable_kernel_repo }}" kernel
      ansible.builtin.apt:
        default_release: "{{ unstable_kernel_repo }}"
        name:
          - "linux-image-{{ unstable_kernel_version }}-{{ ansible_facts.proc_cmdline.BOOT_IMAGE is search('-amd64') | ternary('amd64', 'arm64') }}-unsigned"
      register: _kernel
  tags:
    - unstable-kernel-version

- name: Check if reboot is required
  ansible.builtin.stat:
    path: /var/run/reboot-required
  register: _stat_reboot
  tags:
    - unstable-kernel-version

- name: Reboot if needed
  ansible.builtin.reboot:
    connect_timeout: 5
    reboot_timeout: 60
    pre_reboot_delay: 0
    post_reboot_delay: 25
  when: _stat_reboot.stat.exists or _kernel.changed
  tags:
    - unstable-kernel-version
