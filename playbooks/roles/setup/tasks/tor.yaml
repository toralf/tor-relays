---

- name: Configure repository "backports"
  ansible.builtin.apt_repository:
    filename: 'backports'
    repo: "deb http://mirror.hetzner.com/debian/packages {{ ansible_distribution_release }}-backports main contrib non-free"
    state: present

- name: Get Tor repository apt key
  ansible.builtin.apt_key:
    url: 'https://deb.torproject.org/torproject.org/A3C4F0F979CAA22CDBA8F512EE8CBC9E886DDD89.asc'
    state: present

- name: Configure repository "tor"
  ansible.builtin.apt_repository:
    filename: 'tor'
    repo: "deb https://deb.torproject.org/torproject.org {{ ansible_distribution_release }} main"
    state: present

- name: Install Tor
  ansible.builtin.apt:
    name:
      - tor
      - tor-geoipdb
      - deb.torproject.org-keyring
  register: tor_state

- name: Install obfs4proxy
  ansible.builtin.apt:
    name:
      - obfs4proxy
    default_release: "{{ ansible_distribution_release }}-backports"
  register: obfs4proxy_state

- name: Set caps
  ansible.builtin.capabilities:
    path: /usr/bin/obfs4proxy
    capability: 'cap_net_bind_service=+ep'
    state: present
  when: obfs4_port < 1024
  register: obfs4proxy_cap

- name: Create dirs to configure privileged orport
  ansible.builtin.file:
    state: directory
    path: "/etc/systemd/system/{{ item }}.d"
    recurse: yes
    mode: 0755
  with_items:
    - "tor@default.service"
    - "tor@.service"
    - "tor.service.d"
  when: obfs4_port < 1024

- name: Configure privileged orport
  ansible.builtin.copy:
    src: override_tor_service.conf
    dest: "/etc/systemd/system/{{ item }}.d/override.conf"
    mode: 0644
  with_items:
    - "tor@default.service"
    - "tor@.service"
    - "tor.service.d"
  when: obfs4_port < 1024

- name: Configure torrc
  ansible.builtin.template:
    src: torrc.j2
    dest: /etc/tor/torrc
    mode: 0644

- name: Enable or restart Tor service
  ansible.builtin.systemd:
    name: "tor@default"
    state: restarted
    daemon_reload: yes
    enabled: yes
  when: tor_state.changed or obfs4proxy_state.changed or obfs4proxy_cap.changed or force_restart

- name: Sysctl config
  ansible.builtin.copy:
    src: 20-tor.conf
    dest: /etc/sysctl.d/
    mode: 0644
