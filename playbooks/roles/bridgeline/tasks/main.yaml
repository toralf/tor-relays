---
- name: Ansible defaults
  ansible.builtin.setup:
    gather_subset:
      - "!all"
      - "all_ipv4_addresses"
    gather_timeout: 20

- name: Get fingerprint
  changed_when: false
  ansible.builtin.command: "cut -f 2 -d ' ' /var/lib/tor/fingerprint"
  register: result

- name: Get the fact
  ansible.builtin.set_fact:
    fp: "{{ result.stdout.split('\n')[0] }}"

- name: Get certificate
  changed_when: false
  ansible.builtin.shell: |
    grep -Eo 'cert=\S+' /var/lib/tor/pt_state/obfs4_bridgeline.txt
  register: result

- name: Get the fact
  ansible.builtin.set_fact:
    cert: "{{ result.stdout.split('\n')[0] }}"

- name: Run sort -k 8 /tmp/bridgeline.txt
  delegate_to: localhost
  ansible.builtin.lineinfile:
    line: "Bridge obfs4 {{ '%15s' | format(ansible_eth0.ipv4.address) }}:{{ '%-5s' | format(obfs4_port) }} {{ fp }} {{ cert }} iat-mode=0  # {{ ansible_hostname }}"
    path: /tmp/bridgeline.txt
    create: yes
    mode: "0600"
