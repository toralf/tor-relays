---
- name: Add the snowflake user
  ansible.builtin.user:
    name: snowflake

- name: Create Ansible tmp dir for user snowflake
  ansible.builtin.file:
    path: /home/snowflake/.ansible/tmp
    state: directory
    owner: snowflake
    group: snowflake
    mode: "0700"

- name: Init or update repo for Snowflake
  when: not ansible_check_mode
  become: true
  become_user: snowflake
  ansible.builtin.git:
    repo: https://gitlab.torproject.org/tpo/anti-censorship/pluggable-transports/snowflake.git
    dest: /home/snowflake/snowflake
    version: "{{ snowflake_git_version }}"
    force: true

- name: Apply snowflake patches
  become: true
  become_user: snowflake
  ansible.builtin.shell:
    cmd: curl -s {{ item }} | patch -p 1
    chdir: /home/snowflake/snowflake
  loop_control:
    label: "{{ item }}"
  loop: "{{ snowflake_patches }}"

- name: Build snowflake
  when: not ansible_check_mode
  become: true
  become_user: snowflake
  ansible.builtin.command:
    cmd: go build
    chdir: /home/snowflake/snowflake/proxy

- name: Copy snowflake
  when: not ansible_check_mode
  ansible.builtin.copy:
    src: /home/snowflake/snowflake/proxy/proxy
    dest: /usr/bin/
    mode: a+x
    remote_src: yes
  register: _binary

- name: Set fact
  when: _binary.changed
  ansible.builtin.set_fact:
    force_restart: true
