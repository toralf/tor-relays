---
# https://community.torproject.org/relay/setup/snowflake/standalone/

- name: Install or update Git
  ansible.builtin.apt:
    name:
      - git

- name: Install or update Go
  ansible.builtin.apt:
    default_release: "{{ ansible_facts.distribution_release }}-backports"
    name:
      - golang-go

- name: Add the snowflake user
  ansible.builtin.user:
    name: snowflake

- name: Create Ansible tmp dir for user snowflake
  ansible.builtin.file:
    path: /home/snowflake/.ansible/tmp
    state: directory
    owner: snowflake
    group: snowflake
    mode: "0700"

- name: Prepare repo
  become: true
  become_user: snowflake
  ansible.builtin.git:
    repo: https://gitlab.torproject.org/tpo/anti-censorship/pluggable-transports/snowflake.git
    dest: /home/snowflake/snowflake
    version: "{{ snowflake_git_version }}"
    force: true

- name: Apply patches
  become: true
  become_user: snowflake
  ansible.builtin.shell: |
    curl -s {{ item }} | patch -p 1
  args:
    chdir: /home/snowflake/snowflake
  loop_control:
    label: "{{ item }}"
  loop: "{{ snowflake_patches }}"

- name: Build proxy
  become: true
  become_user: snowflake
  ansible.builtin.command: "go build"
  args:
    chdir: /home/snowflake/snowflake/proxy

- name: Copy proxy
  ansible.builtin.copy:
    src: /home/snowflake/snowflake/proxy/proxy
    dest: /usr/bin/
    mode: a+x
    remote_src: yes
  register: _binary
