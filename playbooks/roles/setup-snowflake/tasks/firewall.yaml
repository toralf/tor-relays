---
- name: ACCEPT incoming UDP to (ephemeral ports of) Snowflake
  ansible.builtin.iptables:
    chain: INPUT
    protocol: udp
    destination: "{{ ansible_facts.default_ipv4.address }}"
    destination_ports: "32768:60999" # /proc/sys/net/ipv4/ip_local_port_range
    jump: ACCEPT

- name: Enable Prometheus to scrape metrics from Snowflake
  when: (prometheus_server is defined) and (prometheus_server is ansible.utils.ipv4) and (metrics_port is defined) and (metrics_port > 0) and (metrics_port < 2**16)
  block:
    - name: Allow Prometheus server to localhost
      ansible.builtin.iptables:
        chain: PREROUTING
        table: nat
        protocol: tcp
        source: "{{ prometheus_server }}"
        destination_port: "{{ metrics_port }}"
        jump: DNAT
        to_destination: "127.0.0.1"
    - name: Allow DNAT traffic to localhost
      ansible.builtin.iptables:
        chain: INPUT
        protocol: tcp
        ctstate: DNAT
        source: "{{ prometheus_server }}"
        destination: "127.0.0.1"
        destination_port: "{{ metrics_port }}"
        jump: ACCEPT
    - name: Allow routing to localhost
      ansible.posix.sysctl:
        name: net.ipv4.conf.all.route_localnet
        value: "1"
        sysctl_file: /etc/sysctl.d/21tor-snowflake.conf
        sysctl_set: true

- name: Save new iptables v4 state
  community.general.iptables_state:
    ip_version: ipv4
    state: saved
    path: /etc/iptables/rules.v4
