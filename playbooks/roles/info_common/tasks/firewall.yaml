---
- name: Get conntrack drop value
  changed_when: false
  ansible.builtin.shell:
    cmd: |-
      conntrack -S |
        grep -v ' insert_failed=0 drop=0 ' |
        awk '{ print $1, $5, $6 }' |
        cut -f 2- -d ':' |
        xargs
  register: _result

- name: File conntrack drop value
  delegate_to: localhost
  throttle: 1
  ansible.builtin.lineinfile:
    line: "{{ inventory_hostname }} {{ _result.stdout }}"
    path: "{{ tmp_dir }}/firewall_conntrack_drop"
    regexp: "^{{ inventory_hostname }} "

- name: Get conntrack counter
  changed_when: false
  failed_when: false
  ansible.builtin.command:
    cmd: conntrack -C
  register: _result

- name: File conntrack counter
  delegate_to: localhost
  throttle: 1
  ansible.builtin.lineinfile:
    line: "{{ inventory_hostname }} {{ _result.stdout }}"
    path: "{{ tmp_dir }}/firewall_conntrack_counter"
    regexp: "^{{ inventory_hostname }} "
    state: "{{ (_result.stderr | length > 0) | ternary('absent', 'present') }}"
