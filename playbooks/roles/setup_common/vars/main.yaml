---
snowflake_metrics: "{{ snowflake_proxies |
  selectattr('state', 'eq', 'present') |
  selectattr('proxy_metrics_port', 'defined') |
  selectattr('proxy_metrics_port', 'gt', 0) |
  length > 0 }}"

kernel_git_build: "{{ (kernel_git_repo_url | length > 0) | ternary('yes', 'no') }}"

# set_fact or vars: works for tasks/blocks but handlers do not know those values, therefore define them here

# Firewall Tor :

# open additional ports
additional_ports_v4: >-
  {{ [ansible_facts.default_ipv4.address] | product(additional_ports) | map('join', ':') }}

additional_ports_v6: >-
  {{ ['[' + ansible_facts.default_ipv6.address + ']'] | product(additional_ports) | map('join', ':') }}

add_local_services_v4: >-
  {{ (additional_ports_v4 | length > 0) | ternary('ADD_LOCAL_SERVICES="' + additional_ports_v4 | join(' ') + '"', '') }}

add_local_services_v6: >-
  {{ (additional_ports_v6 | length > 0) | ternary('ADD_LOCAL_SERVICES6="' + additional_ports_v6 | join(' ') + '"', '') }}

# remote Prometheus server
add_remote_services_v4: >-
  {{ (metrics_port > 0 and prometheus_server != '') |
    ternary('ADD_REMOTE_SERVICES="' + prometheus_server + '>' + metrics_port | string + '"', '') }}

add_remote_services_v6: >-
  {{ (metrics_port > 0 and prometheus_server6 != '' ) |
    ternary('ADD_REMOTE_SERVICES6="[' + prometheus_server6 + ']>' + metrics_port | string + '"', '') }}

# ipv4 for relays and bridges
configured_relays_v4: >-
  {{ 'CONFIGURED_RELAYS="' + ansible_facts.default_ipv4.address + ':' + tor_port | string + '"' }}

# no ipv6 for bridges
configured_relays_v6: >-
  {{ (tor_bridge_distribution == '') |
    ternary('CONFIGURED_RELAYS6="[' + ansible_facts.default_ipv6.address + ']:' + tor_port | string + '"', '') }}
