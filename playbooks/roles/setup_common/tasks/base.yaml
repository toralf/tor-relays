---
- name: Create Ansible tmp dir for user root
  ansible.builtin.file:
    path: /root/.ansible/tmp
    state: directory
    mode: "0700"
  register: _ansible_tmp

- name: Set the hostname
  ansible.builtin.hostname:
    name: "{{ inventory_hostname }}"

- name: Configure sshd
  ansible.builtin.copy:
    src: 00sshd.conf
    dest: /etc/ssh/sshd_config.d/
  notify: Reload ssh

- name: Remove cloud init config for sshd at IONOS
  when: ansible_facts.system_vendor == 'QEMU'
  ansible.builtin.file:
    path: /etc/ssh/sshd_config.d/50-cloud-init.conf
    state: absent
  notify: Reload ssh

- name: Have only 1 authorized key
  changed_when: false
  failed_when: _result.stdout_lines | length != 1
  ansible.builtin.shell:
    cmd: wc -l </root/.ssh/authorized_keys
  register: _result

- name: Stop and disable Debian services
  when: ansible_facts.distribution in ('Debian', 'Ubuntu')
  ansible.builtin.systemd_service:
    name: "{{ item }}"
    state: stopped
    enabled: false
  loop:
    - fstrim.timer

- name: Stop and disable Ubuntu services
  when: ansible_facts.distribution in ('Ubuntu')
  ansible.builtin.systemd_service:
    name: "{{ item }}"
    state: stopped
    enabled: false
  loop:
    - multipathd
    - rsyslog

# (re)created at the end of the setup
- name: Remove unattended auto upgrade config
  ansible.builtin.file:
    path: /etc/apt/apt.conf.d/20auto-upgrades
    state: absent

- name: Create swapfile for systems with small RAM
  when: ansible_facts.memtotal_mb < 2048 and (kernel_vanilla or tor_port is defined)
  ansible.builtin.shell:
    cmd: |-
      set -euf

      fallocate -l 2G /swapfile
      chmod 600 /swapfile
      mkswap /swapfile
      if ! grep -q "^/swapfile " /etc/fstab; then
        echo "/swapfile  none  swap  defaults  0  0" >>/etc/fstab
      fi
      swapon /swapfile
    creates: /swapfile
