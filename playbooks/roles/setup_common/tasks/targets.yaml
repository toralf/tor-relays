---
- name: Targets
  module_defaults:
    ansible.builtin.lineinfile:
      create: true
      firstmatch: true
      mode: "0644"
      line: '- targets: ["{{ inventory_hostname }}:{{ metrics_port | default(0) }}"]'
      regexp: '^- targets: \["{{ inventory_hostname }}:'
  block:
    - name: DDoS targets
      delegate_to: localhost
      throttle: 1
      ansible.builtin.lineinfile:
        path: "{{ tmp_dir }}/targets_tor-ddos.yaml"
        state: "{{ (ddos_metrics | default(false)) | ternary('present', 'absent') }}"

    - name: Node targets
      delegate_to: localhost
      throttle: 1
      ansible.builtin.lineinfile:
        path: "{{ tmp_dir }}/targets_node.yaml"
        state: "{{ (node_metrics | default(false)) | ternary('present', 'absent') }}"

    - name: Snowflake targets
      delegate_to: localhost
      throttle: 1
      ansible.builtin.lineinfile:
        path: "{{ tmp_dir }}/targets_{{ item.name }}.yaml"
        state: "{{ (item.state == 'present' and snowflake_metrics | default(false)) | ternary('present', 'absent') }}"
      loop_control:
        label: "{{ item.name }}"
      loop: "{{ snowflake_proxies | default([]) }}"

    - name: Tor bridge targets
      delegate_to: localhost
      throttle: 1
      ansible.builtin.lineinfile:
        path: "{{ tmp_dir }}/targets_tor-bridge.yaml"
        state:
          "{{ (tor_metrics is defined | default(false) and bridge_distribution | default(false)) |
          ternary('present', 'absent') }}"

    - name: Tor server targets
      delegate_to: localhost
      throttle: 1
      ansible.builtin.lineinfile:
        path: "{{ tmp_dir }}/targets_tor-server.yaml"
        state:
          "{{ (tor_metrics | default(false) and (bridge_distribution is undefined or not bridge_distribution)) |
          ternary('present', 'absent') }}"
