---
- name: Targets
  module_defaults:
    ansible.builtin.lineinfile:
      create: true
      firstmatch: true
      mode: "0644"
      line: '- targets: ["{{ inventory_hostname }}:{{ metrics_port }}"]'
      regexp: '^- targets: \["{{ inventory_hostname }}:'
  block:
    - name: DDoS targets
      delegate_to: localhost
      throttle: 1
      ansible.builtin.lineinfile:
        path: "{{ tmp_dir }}/targets_tor-ddos.yaml"
        state: "{{ ddos_metrics | ternary('present', 'absent') }}"

    - name: Node targets
      delegate_to: localhost
      throttle: 1
      ansible.builtin.lineinfile:
        path: "{{ tmp_dir }}/targets_node.yaml"
        state: "{{ node_metrics | ternary('present', 'absent') }}"

    - name: Snowflake targets
      delegate_to: localhost
      throttle: 1
      ansible.builtin.lineinfile:
        path: "{{ tmp_dir }}/targets_{{ item.name }}.yaml"
        state: "{{ item.state }}"
      loop_control:
        label: "{{ item.name }}"
      loop: "{{ snowflake_proxies }}"

    - name: Tor bridge targets
      delegate_to: localhost
      throttle: 1
      ansible.builtin.lineinfile:
        path: "{{ tmp_dir }}/targets_tor-bridge.yaml"
        state: "{{ (tor_metrics and tor_bridge_distribution != '') |
          ternary('present', 'absent') }}"

    - name: Tor server targets
      delegate_to: localhost
      throttle: 1
      ansible.builtin.lineinfile:
        path: "{{ tmp_dir }}/targets_tor-server.yaml"
        state: "{{ (tor_metrics and tor_bridge_distribution == '') |
          ternary('present', 'absent') }}"
