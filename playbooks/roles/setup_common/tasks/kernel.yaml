---
- name: Configure repository "backports"
  when: kernel_debian_backports
  ansible.builtin.apt_repository:
    filename: backports
    repo: "deb http://deb.debian.org/debian {{ ansible_facts.distribution_release }}-backports main"

- name: Install Cloud kernel
  ansible.builtin.apt:
    default_release: "{{ ansible_facts.distribution_release }}{{ kernel_debian_backports | ternary('-backports', '') }}"
    name:
      - "linux-image-cloud-{{ (ansible_facts.architecture == 'x86_64') | ternary('amd64', 'arm64') }}"
  notify: "Reboot system"

- name: Remove non-Cloud kernel
  ansible.builtin.apt:
    name:
      - "linux-image-{{ (ansible_facts.architecture == 'x86_64') | ternary('amd64', 'arm64') }}"
    state: absent

- name: Ensure kernel crash dumps are made to /tmp
  ansible.builtin.cron:
    name: "core debug files"
    special_time: reboot
    job: "echo '/tmp/core.\\%e.\\%p.\\%s.\\%t' > /proc/sys/kernel/core_pattern"
