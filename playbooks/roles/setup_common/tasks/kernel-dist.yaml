---
- name: Debian kernel
  when: ansible_facts.distribution in ('Debian')
  block:
    - name: Install desired Debian kernel
      when: kernel_debian_backports or kernel_debian_cloud
      vars:
        _arch: "{{ (ansible_facts.architecture == 'x86_64') | ternary('amd64', 'arm64') }}"
        _backports: "{{ kernel_debian_backports | ternary('-backports', '') }}"
        _cloud: "{{ kernel_debian_cloud | ternary('-cloud', '') }}"
      ansible.builtin.apt:
        default_release: "{{ ansible_facts.distribution_release }}{{ _backports }}"
        name:
          - "linux-image{{ _cloud }}-{{ _arch }}"
      register: _kernel_dist
      notify: Reboot system

    - name: Handle new Debian kernel
      when: _kernel_dist is defined and _kernel_dist.changed
      block:
        - name: Reboot into new Debian kernel
          ansible.builtin.meta: flush_handlers

        - name: Upgrade for new Debian kernel
          ansible.builtin.import_tasks: upgrade.yaml

        - name: Reboot after upgrade for new Debian kernel
          ansible.builtin.meta: flush_handlers
