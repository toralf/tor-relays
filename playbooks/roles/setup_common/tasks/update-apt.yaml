---
- name: Stop and disable unattended upgrades
  ansible.builtin.systemd_service:
    name: "{{ item }}"
    state: stopped
    enabled: false
    no_block: false
  loop:
    - unattended-upgrades

- name: Allow phased updates in Ubuntu
  when: ansible_facts.distribution in ('Ubuntu')
  ansible.builtin.copy:
    src: 20phased-updates
    dest: /etc/apt/apt.conf.d/

- name: Install/Update dep package for Ansible
  ansible.builtin.apt:
    name:
      - python3-psutil

- name: Ensure no package manager is running
  failed_when: _processes.pids
  retries: 3
  delay: 60
  community.general.pids:
    pattern: apt.*|dpkg.*
  register: _processes

- name: De-install freeipmi at IONOS
  when: ansible_facts.system_vendor == 'QEMU'
  ansible.builtin.apt:
    name:
      - freeipmi-common
    state: absent

- name: Install/Update common software
  ansible.builtin.apt:
    name:
      - curl
      - git
      - needrestart
      - psmisc
      - rsync
      - sysstat

- name: Do not run Git cleanup in background for tiny systems
  when: ansible_facts.memtotal_mb < 4096 or ansible_facts.processor_vcpus < 4
  changed_when: false
  ansible.builtin.command:
    cmd: git config --global --add gc.autoDetach false

- name: Ensure systat is enabled and started
  ansible.builtin.systemd_service:
    name: sysstat
    state: started
  tags:
    - meow

- name: Install/Update additional software
  when: additional_software
  ansible.builtin.apt:
    name: "{{ additional_software }}"
