---
- name: Install/Update config software
  ansible.builtin.apt:
    name:
      - cron
      - htop
      - logrotate
      - minicoredumper

- name: Tweak readline
  ansible.builtin.lineinfile:
    line: set enable-bracketed-paste off
    path: /root/.inputrc

- name: Copy configs
  ansible.builtin.copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
  loop:
    - { src: htoprc, dest: /root/.config/htop/ }
    - { src: .selected_editor, dest: /root/ }

- name: Sysctl config
  ansible.builtin.copy:
    src: 20tor-system.conf
    dest: /etc/sysctl.d/
  register: _sysctl_state

- name: Ensure sysctl values are up to date
  changed_when: _sysctl_state.changed or _sysctl_result.stderr
  failed_when: false
  ansible.builtin.command:
    cmd: sysctl --system 1>/dev/null
  register: _sysctl_result

- name: Set common sysctl values
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    sysctl_file: /etc/sysctl.d/21common.conf
    sysctl_set: true
  loop:
    - { name: kernel.sysrq, value: 0 }
    - { name: net.ipv4.tcp_fin_timeout, value: 10 }
    - { name: net.ipv4.tcp_notsent_lowat, value: 131072 }
    - { name: net.ipv6.ip_nonlocal_bind, value: 1 }

- name: Set crontab vars
  ansible.builtin.cron:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    env: true
  loop:
    - { name: PATH, value: /usr/sbin:/usr/bin:/sbin/:/bin }
    - { name: SHELL, value: /bin/bash }

- name: Ensure kernel crash dumps are made using minicoredumper
  ansible.builtin.cron:
    name: core debug files
    special_time: reboot
    job: >-
      echo '|/usr/sbin/minicoredumper \%P \%u \%g \%s \%t \%h \%e' >/proc/sys/kernel/core_pattern;
      echo 0x7fffffff >/proc/sys/kernel/core_pipe_limit

- name: Ensure system mailfile is not too big
  ansible.builtin.cron:
    name: regulary truncate system mail file
    special_time: daily
    job: >-
      n=$(wc -l </var/mail/mail);
      if [[ $n -gt 10000 ]]; then
      sed -i -e "1,$((n - 10000))d" /var/mail/mail;
      while [[ -s /var/mail/mail ]] && ! head -n 1 /var/mail/mail | grep -q '^From ';
      do
      sed -i -e "1d" /var/mail/mail;
      done;
      fi

- name: Configure journalctl max size
  ansible.builtin.lineinfile:
    line: SystemMaxUse=100M
    path: /etc/systemd/journald.conf
    regexp: "^[#]*SystemMaxUse="
  notify: Restart systemd-journald

- name: Ensure that logrotate systemd override directory does exist
  ansible.builtin.file:
    path: /etc/systemd/system/logrotate.timer.d/
    state: directory
    mode: "0755"
  notify: Reload systemd

- name: Add logrotate systemd override config
  ansible.builtin.template:
    src: logrotate.override.conf.j2
    dest: /etc/systemd/system/logrotate.timer.d/override.conf
  notify: Reload systemd

# both nginx and Tor refuses to start, if IPv6 is not up
- name: Ensure that Networkd wait online systemd override dir exists
  ansible.builtin.file:
    path: /etc/systemd/system/systemd-networkd-wait-online.service.d/
    state: directory
    mode: "0755"

- name: Add Networkd wait online systemd override
  ansible.builtin.template:
    src: networkd-wait-online.override.conf.j2
    dest: /etc/systemd/system/systemd-networkd-wait-online.service.d/override.conf
  notify:
    - Reload systemd

- name: No apport
  when: ansible_facts.distribution in ('Ubuntu')
  ansible.builtin.apt:
    name:
      - apport
      - whoopsie
      - whoopsie-preferences
    state: absent

- name: Create swapfile for systems with small RAM
  when: ansible_facts.memtotal_mb < 2048 and (kernel_build_from_source or tor_port is defined)
  ansible.builtin.shell:
    cmd: |-
      set -euf

      fallocate -l 2G /swapfile
      chmod 600 /swapfile
      mkswap /swapfile
      if ! grep -q "^/swapfile " /etc/fstab; then
        echo "/swapfile  none  swap  defaults  0  0" >>/etc/fstab
      fi
      swapon /swapfile
    creates: /swapfile
