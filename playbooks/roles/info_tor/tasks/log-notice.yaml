---
- name: Get last {{ log_lines }} lines of {{ log_notice }}
  changed_when: false
  ansible.builtin.shell:
    cmd: |-
      set -euf

      diff=$((EPOCHSECONDS - $(stat -c %Z {{ log_notice }})))
      if [[ $diff -gt $((2 * 3600)) ]]; then
        echo "{{ log_notice }} is older than $diff seconds" >&2
      fi

      grep -h -v -F \
        -e 'Please upgrade! This version of Tor' \
        -e 'The IPv4 ORPort address 127.0.0.1 does not match' {{ log_notice }}.1 {{ log_notice }} \
        -e 'Unrecognized BridgeDistribution value' \
        2>/dev/null |
        tail -n {{ log_lines }}
    executable: /bin/bash
  register: _result

- name: Results of log-notice {{ log_lines }} last lines
  when: _result.stdout_lines
  ansible.builtin.debug:
    var: _result.stdout_lines

- name: Error
  when: _result.stderr_lines
  ansible.builtin.debug:
    var: _result.stderr_lines
