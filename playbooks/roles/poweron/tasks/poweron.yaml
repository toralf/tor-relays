---
- name: Ping the system
  ansible.builtin.ping:
  register: _ping
  ignore_errors: true
  ignore_unreachable: true

- name: Power on the system
  delegate_to: localhost
  throttle: "{{ concurrent_local_jobs }}"
  changed_when: true
  when: _ping.unreachable is defined or _ping.ping is not defined
  ansible.builtin.shell:
    cmd: |-
      set -euf

      hcloud --quiet --poll-interval 10s server poweron {{ inventory_hostname }}
      sleep 10

      i=15
      while (( i-- )); do
        if ping -q -c 1 {{ inventory_hostname }}; then
          sleep 15
          exit 0
        fi
      done

      exit 2
    executable: /bin/bash
