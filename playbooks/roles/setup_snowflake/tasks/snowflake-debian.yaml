---
- name: Install or update Snowflake
  when: not ansible_check_mode
  ansible.builtin.apt:
    name:
      - snowflake-proxy
  notify: "Restart Snowflake"

- name: Ensure that systemd override dir exists
  ansible.builtin.file:
    path: /etc/systemd/system/snowflake-proxy.service.d/
    state: directory

- name: Override systemd defaults
  ansible.builtin.blockinfile:
    create: true
    dest: /etc/systemd/system/snowflake-proxy.service.d/override.conf
    block: |
      [Service]
      NoNewPrivileges=no
  notify: "Restart Snowflake"

- name: Handle low memory
  when: ansible_facts.memtotal_mb < 1024
  ansible.builtin.lineinfile:
    line: "MemoryHigh=700MB"
    path: /etc/systemd/system/snowflake-proxy.service.d/override.conf
    insertafter: "NoNewPrivileges=no"
  notify: "Restart Snowflake"
